---
title: "開発経済論: データ視覚化"
subtitle: |
  聖心女子大学国際交流学科\
  2024年秋学期
author: "アジア経済研究所 伊藤成朗"
engine: knitr
execute:
  echo: false
  freeze: auto
filters:
  - nutshell
format:
  revealjs:
    standalone: true
    embed-resources: true
    slide-number: true
    incremental: true
    width: 1600
    height: 900
    preview-links: auto
    logo: GrootbergGiraffeHead.jpg
    footer: <http://seiroito.github.io/SHLectures/lec_slides/2024/DataVis.html>
    theme: 
      - sky
      - ../../seirosky.scss
    linkcolor: red
    code-line-numbers: true
    code-copy: true
    code-block-border-left: "#31BAE9"
    toc: true
    toc-depth: 1
    template-partials: 
      - ../../toc-slide.html
    includes:
      in_header: ../../sky_add_FilePointer.html
      after-body: ../../toc-add.html
    toc-bg-image: "../../GrootbergGiraffe3.jpg"
    css:
      - ../../seiro.css
#### Looks like seiro.css in sky_add_FilePointer.html does not work but local ../../seiro.css works
#### Don't understand why
lightbox: auto
displayMode: compact
include-in-header:
  - text: |
      <style>
       .title {
        font-size: 2.0em;
      }
      </style>
#### From https://github.com/quarto-dev/quarto-cli/discussions/2951
#### I am happy with the left-indenting of the section line
#### Horizontal centering can be challenging (!) in quarto: stupid
#### https://github.com/quarto-dev/quarto-cli/issues/1231
#### It turns out an easy solution is :::{style="text-align: center;"}
  - text: |
      <style>
      .center-xy {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 20%;
        -ms-transform: translateY(-50%), translateX(-50%);
        transform: translateY(-50%), translateX(-50%);
      }
      </style>
include-before-body:
#### latex math shorthand
  file: ../../MathShorthand.html 
#### bib file at doc folder root
bibliography: ../../seiro.bib
####../../../../seiro.bib
resources:
  - DataVis.pdf
# quarto render DataVis.qmd
---
```{css}
.math.inline .MathJax  {
  font-size: 80% !important;
}
.mermaid-render svg {
    width: 70%; 
}
/* description with a font size control (font size control not effective) */
/* Main container for the description list */
.des-list-boxed {
    font-size: 100% !important;  /* Default font size */
    line-height: 1.2 !important;  /* Sets line height to 1.2 times the font size */
}
/* Specific font size override */
.des-list-boxed[data-font-size] {
    font-size: attr(data-font-size string, 60%) !important;
}
.des-list-boxed dl {
    margin-left: 0;  /* Removes default left margin */
    padding-left: 0;  /* Removes default left padding */
    width: 100%;  /* Ensures the container takes full width */
}
.des-list-boxed dt {
    font-weight: bold;  /* Makes the term text bold */
    text-align: right;  /* Right aligns the term text */
    padding-right: 1em;  /* Adds spacing after the term */
    float: left;  /* Allows description to wrap around header */
    white-space: nowrap;  /* Prevents item header from wrapping */
}
.des-list-boxed dd {
    margin-left: 0;  /* Removes default left margin */
    overflow: hidden;  /* Clears float */
}
.des-list-boxed dd p {
    margin: 0;  /* Removes default paragraph margins */
    word-wrap: break-word;  /* Allows description to wrap */
    overflow-wrap: break-word;  /* Modern alternative to word-wrap */
}
.des-list-boxed dd p:first-child {
    /* First line of description */
    /* No special styling needed, will naturally wrap around header */
}
.des-list-boxed dd p:not(:first-child) {
    /* Lines after the first line */
    display: block;  /* Ensures full width */
    margin-left: 1em;  /* Indentation for subsequent lines */
}
.des-list-boxed dd::after {
    content: "";  /* Necessary for the pseudo-element to render */
    display: block;  /* Creates a line break */
    margin-bottom: 0.5em;  /* Adds space between items */
    clear: both;  /* Clears the float */
}
```

::: {style="text-align: center;"}
# はじめに
:::

----

::::::::::{.columns}
::::{.column width="70%"}
![](DataVisualisation/SnowMap.jpg){width="90%"}
::::

::::{.column width="30%"}
* 伝えたいことを一発で伝える
* コレラ発症件数のドット地図
* 仮説: 水・飛沫媒介の感染
* メカニズム: ウィルス汚染された水&rarr;ポンプ&rarr;感染蔓延
  * The pump: Cambridge Street & Broad Street 
  * 最近接ポンプ=The pump
  * Placebo test: Brewery

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px; height: 10px;">[Map of the book "On the Mode of Communication of Cholera" by John Snow, originally published in 1854 by C.F. Cheffins, Lith, Southhampton Buildings, London, England.](https://commons.wikimedia.org/wiki/File:Snow-cholera-map-1.jpg)</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::::::::

----

```{r school enrollment, results = "hide", echo = F}
library(qs)
library(data.table)
grepout <- function(str, x)
  # returns element of match (not numbers)
  x[grep(str, x, perl = T)]
SMHGd <- qread("HK/SchoolingInfantMortalityGDP.qs")
SMHGd[, Latest := max(year, na.rm = T), by = .(country, variable)]
SMHGdGDP <- SMHGd[grepl("GD", variable), ]
setnames(SMHGdGDP, "value", "pcGDP")
SMHGdGDP[, grepout("name|varia|indi|Lat", colnames(SMHGdGDP)) := NULL]
SMHGd2 <- merge(SMHGd, SMHGdGDP, 
  by = intersect(colnames(SMHGd), colnames(SMHGdGDP)), all = T)
noncountries <- "Euro|Fragi|OEC|small|IB|IDA|HIP|UN|income|Midd|Not|Asi|Sub|Latin|divid|Worl|\\&|th America|Small s"
SMHGd2 <- SMHGd2[!grepl(noncountries, country)]
SMHGd2[, Latest := max(year[!is.na(value)], na.rm = T), by = .(country, variable)]
table(unique(SMHGd2[ , .(country, indicator, Latest)])[, .(indicator, Latest)])
#### if year == 2020, most data are almost complete
SMHGd2[, name := NULL]
SMHGd2[, NumNonNA := sum(!is.na(value)), by = year]
unique(SMHGd2[, .(year, NumNonNA)][year > 2020, ])
SMHGd2[year == 2020, ]
SMHGd2[grepl("mor", variable), value := value/10]
SMHGd2[, variableJ := factor(variableJ, levels = 
  c("初等教育", "中等教育", "高等教育", "非低身長", "低身長", "乳児死亡率"))]
#### top incomes
setorder(SMHGd2, -pcGDP)
####SMHGd2[!is.na(pcGDP), ][year == 2020 & grepl("GD", variable), ][1:20, 
####  .(country, value)]
library(ggplot2)

#### no faceting
SMHGd2[, edulevel := "primary"]
SMHGd2[grepl("dary", variable), edulevel := "secondary"]
SMHGd2[grepl("tiary", variable), edulevel := "tertiary"]
SMHGd2[, edulevel := factor(edulevel)]
pS1 <- ggplot(data = SMHGd2[year == 2020 & !grepl("GD|mor|Stu", variable) &
  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ], 
  aes(x = pcGDP, y = value, group = edulevel, shape = edulevel, fill = edulevel, colour = edulevel)) +
  geom_point(size = 1.7) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算、2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "就学率(パーセント, 2020年)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  geom_smooth(aes(group = edulevel, colour = edulevel))+
  scale_colour_viridis_d(end = .7, aes(group = edulevel))+
  geom_hline(yintercept = 100, colour = "red") +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )
pSby3 <- ggplot(data = SMHGd2[year == 2020 & !grepl("GD|mor|Stu", variable) &
  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ], 
  aes(x = pcGDP, y = value, group = edulevel, shape = edulevel, fill = edulevel, colour = edulevel)) +
  geom_point(size = .7) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算、2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "就学率(パーセント, 2020年)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  geom_smooth() +
  scale_colour_viridis_d(end = .7, aes(group = edulevel))+
  geom_hline(yintercept = 100, colour = "red") +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  ) + 
  facet_grid(variableJ ~ .)
  #### No high income country reports under 5 stunting rate
pH <- ggplot(data = SMHGd2[year == 2020 & grepl("U5N", variable) &
  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ], 
  aes(x = pcGDP, y = 100-value*100)) +
  geom_point(size = .7) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "5歳以下低身長(パーセント, 2020年)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  geom_smooth() +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )
pM <- ggplot(data = SMHGd2[year == 2020 & grepl("mor", variable) &
  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ], 
  aes(x = pcGDP, y = value)) +
  geom_point(size = .7) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算、2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "乳児死亡率(パーセント、2020年)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  geom_smooth() +
  ggrepel::geom_text_repel(data = SMHGd2[year == 2020 & grepl("mor", variable) & 
    !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country) & 
    pcGDP > 10000 & value > 5 & grepl("inf", indicator), ], aes(label = country))+
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )
SMHGd2[, Year := factor(year)]
pM19902020 <- ggplot(data = SMHGd2[(year == 1990 | year == 2020) & grepl("mor", variable) &
  !is.na(value) &
  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ], 
  aes(x = pcGDP, y = value, group = Year, shape = Year, colour = Year)) +
  geom_point(size = 1.2) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算、2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "乳児死亡率(パーセント)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  geom_smooth() +
  scale_colour_viridis_d(end = .7)+
  annotate("text", x = 800, y = 5, label = "2020")+
  annotate("text", x = 800, y = 16, label = "1990")+
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )
pMData <- SMHGd2[(year == 1990 | year == 2020) & grepl("mor", variable) &
  !is.na(value) & !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ]
pMDataW <- reshape(pMData, direction = "wide", idvar = "country", 
  timevar = "Year", v.names = grepout("pcG|val|NumN|year", colnames(pMData)))
pM19902020Arrow <- ggplot(data = pMData, 
  aes(x = pcGDP, y = value, group = country)) +
  geom_point(data = pMData, size = 1.2, aes(shape = Year, colour = Year)) + 
  scale_shape_manual(values = c(16, 15), aes(shape = Year)) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算、2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "乳児死亡率(パーセント)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  scale_colour_viridis_d(end = .7, aes(group = Year))+
  annotate("text", x = 800, y = 5, label = "2020")+
  annotate("text", x = 800, y = 16, label = "1990")+
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  ) +
  geom_segment(data = pMDataW,
    aes(x=pcGDP.1990, xend=pcGDP.2020, y=value.1990, yend=value.2020), 
    arrow = arrow(angle = 20, length = unit(.15, "cm"), type = "closed"), 
    size = .2, alpha = .2, colour = "blue")
pM19902020ArrowS <- pM19902020Arrow +
  geom_smooth(data = pMData, aes(group = Year, colour = Year))
pMplus <- ggplot(data = SMHGd2[year == 2020 & grepl("mor", variable) &
  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country), ], 
  aes(x = pcGDP, y = value)) +
  geom_point(size = .7) +
  scale_x_log10(
  #scale_x_continuous(
  name = "1人当たりGDP(2020年、PPP換算、2017年価格、対数表示)") +
  #scale_y_log10(
  scale_y_continuous(
  name = "乳児死亡率(パーセント)"
     #, breaks = c(1, 2, 4, 8), limits = c(1, 9)
  )+
  geom_smooth() +
  ggrepel::geom_text_repel(data = SMHGd2[year == 2020 & grepl("mor", variable) & 
    !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country) & 
    pcGDP > 10000 & value > 5 & grepl("inf", indicator), ], aes(label = country), color = "red")+
  #### Add 1990, 2000, 2010 data for Equatorial Guinea & Uganda & Burkina
  geom_point(data = SMHGd2[grepl("mor", variable) & 
    (year == 1990 | year == 2000 | year == 2010 | year == 2020) &
    grepl("E.*Gui", country) & grepl("inf", indicator), ],
    size = 1.5, color = "red") +
  ggrepel::geom_text_repel(data = SMHGd2[grepl("mor", variable) & 
    (year == 1990 | year == 2000 | year == 2010) &
    grepl("E.*Gui", country) & grepl("inf", indicator), ], aes(label = year), color = "red")+
  geom_point(data = SMHGd2[grepl("mor", variable) & 
    (year == 1990 | year == 2000 | year == 2010 | year == 2020) &
    grepl("Uga", country) & grepl("inf", indicator), ],
    size = 1.5, color = "darkgreen") +
  ggrepel::geom_text_repel(data = SMHGd2[grepl("mor", variable) & 
    (year == 1990 | year == 2000 | year == 2010) &
    grepl("Uga", country) & grepl("inf", indicator), ], aes(label = year), color = "darkgreen")+
  ggrepel::geom_text_repel(data = SMHGd2[year == 2020 & grepl("mor", variable) & 
    grepl("Uga", country) & grepl("inf", indicator), ], aes(label = country), color = "darkgreen")+
  geom_point(data = SMHGd2[grepl("mor", variable) & 
    (year == 1990 | year == 2000 | year == 2010 | year == 2020) &
    grepl("Faso", country) & grepl("inf", indicator), ],
    size = 1.5, color = "#660000") +
  ggrepel::geom_text_repel(data = SMHGd2[grepl("mor", variable) & 
    (year == 1990 | year == 2000 | year == 2010) &
    grepl("Faso", country) & grepl("inf", indicator), ], aes(label = year), color = "#660000")+
  ggrepel::geom_text_repel(data = SMHGd2[year == 2020 & grepl("mor", variable) & 
    grepl("Faso", country) & grepl("inf", indicator), ], aes(label = country), color = "#660000")+
  theme(
    legend.position = "none",
    axis.title = element_text(size = 7),
    axis.text.x = element_text(size = 6, hjust = .5),
    axis.text.y = element_text(size = 6, hjust = 1),
    strip.text.x = element_text(color = "blue", size = 6, 
      margin = margin(0, .5, 0, .5, "cm")), 
    strip.text.y = element_text(color = "blue", size = 6, 
      margin = margin(.5, 0, .5, 0, "cm"))
  )
####  SMHGd2[year == 2011 & grepl("mor", variable) & 
####  !grepl("Qat|Maca|Lux|Brun|Kuw|Marino|Cayma", country) & 
####  pcGDP > 10000 & value > 5 & grepl("inf", indicator), ] 
####  This is Equatorial Guinea 2011   infant mortality=7.7 GDP= 35378
ggsave(
  "DataVisualisation/SchoolEnrollmentInASinglePlot.jpg"
  , pS1,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
ggsave(
  "DataVisualisation/SchoolEnrollment.jpg"
  , pSby3,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
ggsave(
  "DataVisualisation/InfantMortality.jpg"
  , pM,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
ggsave(
  "DataVisualisation/InfantMortality19902020.jpg"
  , pM19902020,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
ggsave(
  "DataVisualisation/InfantMortality19902020Arrow.jpg"
  , pM19902020Arrow,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
ggsave(
  "DataVisualisation/InfantMortality19902020ArrowS.jpg"
  , pM19902020ArrowS,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
ggsave(
  "DataVisualisation/InfantMortalityPlus.jpg"
  , pMplus,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
cairo_pdf(
  "DataVisualisation/SchoolEnrollment.pdf"
  , width=12/2.54, height=12/2.54, family = "Meiryo")
print(pSby3)
whatever <- dev.off()
```

::::::::::{.columns}
2変数の関係

::::{.column width="60%"}
![](DataVisualisation/InfantMortality.jpg){width="80%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Constructed using World Development Indicators]()</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="40%"}
* 散布図scatter plot
* 意図: 横軸 &rArr; 縦軸
::::
::::::::::

----

```{r anscombe}
ad <- textConnection("10.0 8.04 10.0 9.14 10.0 7.46 8.0 6.58
8.0 6.95 8.0 8.14 8.0 6.77 8.0 5.76
13.0 7.58 13.0 8.74 13.0 12.74 8.0 7.71
9.0 8.81 9.0 8.77 9.0 7.11 8.0 8.84
11.0 8.33 11.0 9.26 11.0 7.81 8.0 8.47
14.0 9.96 14.0 8.10 14.0 8.84 8.0 7.04
6.0 7.24 6.0 6.13 6.0 6.08 8.0 5.25
4.0 4.26 4.0 3.10 4.0 5.39 19.0 12.50
12.0 10.84 12.0 9.13 12.0 8.15 8.0 5.56
7.0 4.82 7.0 7.26 7.0 6.42 8.0 7.91
5.0 5.68 5.0 4.74 5.0 5.73 8.0 6.89")
ad <- data.table(read.table(ad))
setnames(ad, paste0(c("x", "y"), rep(paste0(".data", 1:4), each = 2)))
adL <- reshape(ad, direction = "long", varying = colnames(ad))
library(ggplot2)
g <- ggplot(data = adL, 
  aes(x = x, y = y)) +
  geom_point(size = 1.75, colour = "red") +
  #geom_smooth(colour = "blue") +
  geom_abline(intercept = 3, slope = .5) +
  facet_wrap( ~ time, nrow = 2) +
  theme_light()
ggsave(
  "DataVisualisation/Anscombe.jpg"
  , g,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
```

::::::::::{.columns}
2変数の関係

::::{.column width="40%"}
::: {style="font-size: 70%;line-height: 1.1;"}
```{r anscombe table}
library(tinytable)
adTab <- ad
adTab[, grepout("x.*[2-4]", colnames(adTab)) := NULL]
setnames(adTab, c("x", gsub("y.", "", colnames(adTab)[-1])))
setnames(adTab, c("x", gsub("data", "y", colnames(adTab)[-1])))
tb <- tt(adTab, width = .8)
tb <- group_tt(tb, j = list("x" = 1, "y" = 2:5))
style_tt(tb, j = 1:5, align = "rrrrr")
```
:::

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">出所: [Anscombe's quartet](https://en.wikipedia.org/wiki/Anscombe's_quartet)</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>

Anscombeデータ: 各yの平均値=7.5、xと各yの相関係数=.816、回帰線$y=3+.5x$
::::

::::{.column width="60%"}
![](DataVisualisation/Anscombe.jpg){width="70%"}

* 記述統計と回帰分析だけだと違いを見失う

::::
::::::::::

----

```{r density}
set.seed(20250115)
d1 <- rnorm(100*10)
d21 <- rnorm(50*4, mean = -4)
d22 <- rnorm(50*8, mean = 2)
d3 <- rnorm(100*10, sd = 3.13)
plotd <- data.table("value.first"=d1, "value.second"=c(d21, d22), "value.third"=d3)
plotdL <- reshape(plotd, direction = "long", varying = colnames(plotd))
library(ggplot2)
g <- ggplot(data = plotdL, aes(x=value, group = time, colour = time, fill = time)) +
  geom_density(alpha = 0.1) +
  scale_colour_viridis_d(end = .7) +
  theme_light() + theme(legend.position="none")
ggsave(
  "DataVisualisation/TwoDistributions.jpg"
  , g,
  width = 8*2, height = 8*2, units = "cm", dpi = 300
 )
skewness <- function(x) sum((x-mean(x))^3)/((length(x)-1)*sd(x)^3)
```

::::::::::{.columns}
1変数の分布比較(連続変数continuous variables)

::::{.column width="50%"}
![](DataVisualisation/TwoDistributions.jpg){width="90%"}
::::

::::{.column width="50%"}
* 平均値が同じ3分布
* 分散は`r lapply(lapply(plotd, var), round, 2)`で、後2者は判別不能
* 歪度skewnessは`r lapply(lapply(plotd, skewness), round, 2)`で、後2者は判別可能
* 描くと直感的に把握できる
::::
::::::::::

----

```{r gbd, fig.show = "hide"}
gbd <- fread("DataVisualisation/GBD2024.prn", nThread = 8)
#### asmr: age standardised mortality rate
#### aad: all age deaths (counts)
setnames(gbd, c("LocType", "LocName", "cause", 
  paste0("asmr", c(1990, 2010, 2019:2021)), 
  paste0("aad", c(1990, 2010, 2019:2021))
))
gbd[, asmr.1990 := gsub(" +.*", "", asmr1990)]
gbd[, aad.1990 := gsub(" +.*", "", aad1990)]
gbd[, asmr.2021 := gsub(" +.*", "", asmr2021)]
gbd[, aad.2021 := gsub(" +.*", "", aad2021)]
numcols <- paste0(rep(c("asmr.", "aad."), each = 2), c(1990, 2021))
gbd[, (numcols) := lapply(.SD, as.numeric), .SDcols = numcols]
faccols <- grepout("Loc|caus|SRe", colnames(gbd))
gbd[, (faccols) := lapply(.SD, as.factor), .SDcols = faccols]
library(treemap)
library(ggfittext)
g2021 <- treemap(dtf = gbd[grepl("Glob", LocName), ],
        index = "cause",
        vSize = "aad.2021",
        vColor = "cause")
g1990 <- treemap(dtf = gbd[grepl("Glob", LocName), ],
        index = "cause",
        vSize = "aad.1990",
        vColor = "cause")
g2021hi <- treemap(dtf = gbd[grepl("^Sup", LocType) & grepl("High", LocName), ],
        index = "cause",
        vSize = "aad.2021",
        vColor = "cause")
g2021sa <- treemap(dtf = gbd[grepl("^Sup", LocType) & grepl("South A", LocName), ],
        index = "cause",
        vSize = "aad.2021",
        vColor = "cause")
g2021ssa <- treemap(dtf = gbd[grepl("^Sup", LocType) & grepl("Saha", LocName), ],
        index = "cause",
        vSize = "aad.2021",
        vColor = "cause")
g1990hi <- treemap(dtf = gbd[grepl("^Sup", LocType) & grepl("High", LocName), ],
        index = "cause",
        vSize = "aad.1990",
        vColor = "cause")
g1990sa <- treemap(dtf = gbd[grepl("^Sup", LocType) & grepl("South A", LocName), ],
        index = "cause",
        vSize = "aad.1990",
        vColor = "cause")
g1990ssa <- treemap(dtf = gbd[grepl("^Sup", LocType) & grepl("Saha", LocName), ],
        index = "cause",
        vSize = "aad.1990",
        vColor = "cause")
for (gg in c("g1990hi", "g1990sa", "g1990ssa", "g2021hi", "g2021sa", "g2021ssa"))
{
  gtdata <- data.table(get(gg)$tm)
  #### calculate end coordinates with height and width
  gtdata[, x1 := x0 + w]
  gtdata[, y1 := y0 + h]
  #### get center coordinates for labels
  gtdata[, xc := (x0+x1)/2]
  gtdata[, yc := (y0+y1)/2] 
  p <- ggplot(gtdata, aes(xmin = y0, ymin = x0, xmax = y1, ymax = x1)) + 
    # add fill and borders for groups
    geom_rect(aes(fill = color),
      show.legend = FALSE, color = "black", alpha = .3) +
    scale_fill_identity() +
    # add labels
    ggfittext::geom_fit_text(aes(label = cause), min.size = 2) +
    # options
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    theme_void()
  ggsave(
    paste0("DataVisualisation/", gg, ".jpg")
    , p,
    width = 8*2, height = 8*2, units = "cm", dpi = 300
   )
}
```

::::::::::{.columns}
1変数の分布比較(離散項目変数categorical variables)

::::{.column width="50%"}
![](DataVisualisation/g2021hi.jpg){width="90%"}
::::

::::{.column width="50%"}
* Tree map
   * 数量を面積で表示
* 棒グラフとして品目数が多すぎるときに有効
   * 限られた空間を効率的に使うため
* 視認性は低い
* 疾病種類が多いこと、代表的な疾病が分かる
* それ以外の情報は存在するという以上の内容がない
::::
::::::::::

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">Constructed using [Global Burden of Disease Collaborative Network. Global Burden of Disease Study 2021 (GBD 2021) Cause-Specific Mortality 1990-2021. IHME, 2024.]()</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>

----

::::::::::{.columns}
1変数の分布比較

::::{.column width="33%"}
![High income, 2021](DataVisualisation/g2021hi.jpg){width="60%"}

![High income, 1990](DataVisualisation/g1990hi.jpg){width="60%"}
::::

::::{.column width="33%"}
![South Asia, 2021](DataVisualisation/g2021sa.jpg){width="60%"}

![South Asia, 1990](DataVisualisation/g1990sa.jpg){width="60%"}
::::

::::{.column width="33%"}
![Sub-Saharan Africa, 2021](DataVisualisation/g2021ssa.jpg){width="60%"}

![Sub-Saharan Africa, 1990](DataVisualisation/g1990ssa.jpg){width="60%"}
::::
::::::::::

----

経緯の視覚化

ベンジャミン・モリスによるステフ・カリーのシュート[@Morris2015]

::::::::::{.columns}
::::{.column width="35%"}
![](DataVisualisation/Curry.jpg){}
::::

::::{.column width="35%"}
![](DataVisualisation/Steph.jpg){}
::::

::::{.column width="30%"}
* 複数年次の散布図
* 両軸は数値
* 時間の変化=同じ個人の点を線でつないで表現
* 年を追うごとに、シュート数が増えながら成功率も増えている
   * 他の有名選手は右下がり: 打ち過ぎると成功率が下がる&larr;疲れ、守備
* Curryなどが台頭してから、NBAゲームの攻撃はパス&3ポインターが主流に
::::
::::::::::

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Kieth Allen](https://commons.wikimedia.org/wiki/File:Stephen_Curry_(24180454343).jpg)</span><span style="text-align: left; font-size: 10px">![](DataVisualisation/cc-by-sa.jpg)</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>

----

### データ視覚化の目的=情報の伝達

* データをそのまま見ていても何が何やら分からない
* データから傾向(変数間の関係、メッセージ)を見出すのが最初
* &#x2B55; 伝えたい傾向がもっとも良く伝わるように視覚化の方法を選ぶ
* &#x274C; 受取手が思考したり、何度も視線を動かしたり、計算をしなくてはいけない視覚化
* &#x274C; 伝えたいメッセージにこだわるあまり、データと矛盾する視覚化の方法を選ぶ
* &#x274C; &#x274C; &#x274C; データ改ざんはもっての外

満たすべき条件[@Tufte1983, p.51; [RSS](https://royal-statistical-society.github.io/datavisguide/docs/why-visualise.html)]


:::{.des-list-boxed}
直感的clear, intuitive
:	メッセージが明快

正確precise
:	情報が歪められていない

効率的efficient
:	ノイズが最小限
:::

----

参考文献

::::::::::{.columns}
::::{.column width="15%"}
![](DataVisualisation/Tufte2001Cover.jpg){width="70%"}
::::
::::{.column width="15%"}
![](DataVisualisation/Tufte1997Cover.jpg){width="70%"}
::::
::::{.column width="15%"}
![](DataVisualisation/Tufte2006Cover.jpg){width="100%"}
::::

::::{.column width="55%"}
Edward Tufte (独創的、読み物的、チャートジャンクの指摘、多彩な例)
::::
::::::::::

::::::::::{.columns}
::::{.column width="15%"}
![](DataVisualisation/Cleveland1985Cover.jpg){width="70%"}
::::
::::{.column width="15%"}
![](DataVisualisation/Cleveland1993Cover.jpg){width="70%"}
::::
::::{.column width="15%"}
::::

::::{.column width="55%"}
William Cleveland (学術的、視認性)
::::
::::::::::

----

参考文献

::::::::::{.columns}
::::{.column width="15%"}
![](DataVisualisation/WilkeBookCover.png){width="70%"}
::::
::::{.column width="15%"}
::::
::::{.column width="15%"}
::::

::::{.column width="55%"}
Claus O. Wilke (分類的、教科書的、[コード](https://github.com/clauswilke/dataviz))

[無料閲覧](https://clauswilke.com/dataviz/)
::::
::::::::::

::::::::::{.columns}
::::{.column width="15%"}
![](DataVisualisation/HealyBookCover.jpg){width="70%"}
::::
::::{.column width="15%"}
::::
::::{.column width="15%"}
::::

::::{.column width="55%"}
Kieran Healy (マニュアル的、ggplot2, dplyr多用、[補助教材](https://github.com/kjhealy/socviz/blob/master/inst/resources/dataviz_course_notes.zip)あり)

[無料閲覧](https://socviz.co/index.html)
::::
::::::::::

::::::::::{.columns}
::::{.column width="15%"}
![](DataVisualisation/RSS_logo_colour.png){width="100%"}
::::
::::{.column width="30%"}
![](DataVisualisation/RSS_DataVisTitle.png){width="100%"}
::::

::::{.column width="55%"}
[Royal Statistical Society(英国)](https://royal-statistical-society.github.io/datavisguide/)
::::
::::::::::

----

::: {style="text-align: center;"}
# 視覚化失敗の費用
:::

----

::: {style="text-align: center;"}
### 極端な例です
:::

----

NASAスペースシャトル・チャレンジャー打ち上げ分解事故(1986年)

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/ChallengerExplosion.jpg){width="100%"}
::::
::::{.column width="40%"}
* 乗員7名全員死亡
* 原因:
   * 燃料タンク接続部分が打ち上げ時加圧で開いたこと
   * 接続部分のゴム製Oリングが打ち上げ当日の低温で硬直化して密閉しなかったこと

:::{.fragment}
高温の燃料漏れ&rarr;燃料タンクが燃焼破損&rarr;ロケット・ブースター接続部分を破壊&rarr;ブースターが回転&rarr;異常な方向への空圧を発生&rarr;シャトル機体が分解&rarr;乗組員キャビンが空中に放出&rarr;高度20kmから海面に激突
:::
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/ShuttleRockets2.jpg){width="80%"}

![](DataVisualisation/ChallengerLiftOff.jpg){width="80%"}
::::
::::{.column width="40%"}
![](DataVisualisation/BoosterSegment.jpg)
::::
::::::::::

----

::: {style="text-align: center;"}
![](DataVisualisation/ChallengerCrew.jpg)
:::

----

* 打ち上げ前夜、エンジンを製作したMorton Thiokol社の技術者は天気予報の低温を理由に打ち上げに反対
* MT社技術者が反対のために準備した資料(13枚): 
   * 最も大事な気温 vs. Oリング破損の関係提示: <Red>無し</Red>
   * SRM15(SRM: MT社内で使用された打ち上げ番号、気温11.6度)とSRM22(気温23.9度)でのOリング破損情報提示
   * Oリング破損があった7件の破損状況の表(気温情報なし)
   * 試作段階エンジンテスト4件とSRM15とSRM22の気温一覧表(その他12件の打ち上げ情報なし、Oリング破損情報なし)
   * 「11.6度以上が打ち上げの条件」という結論

. . .

主張は明快だが根拠が不明快

----

NASA幹部らは度重なる打ち上げ延期を気にしており、早期に打ち上げたいと考えていた\citep{Berkes2012}

. . .

Manager of the Solid Rocket Booster project, George Hardy told Thiokol:

> I am appalled. I am appalled by your recommendation.

Lawrence Mulloy, George C. Marshall Space Flight Center's Manager for the SRB project, said:

> My God, Thiokol, when do you want me to launch---next April?

. . .

NASA幹部たちは打ち上げ延期に反対し、危険である証拠を要求

. . .

最終的にMT社幹部も打ち上げに賛同

* お薦め: Netflixドキュメンタリー**Challenger** (監督Daniel Junge, Steven Leckart), Episode 3, 00:18:00-00:27:00に技術者反対から打ち上げ決定までの詳細あり

----

MT社技術者が用意すべきだった図[@Tufte2006, p.45]

![](DataVisualisation/TufteCorrectedDisplayOfShuttle.png)

* 損傷指数(damage index)は損傷の内容を考慮した総合損傷度合い、事故調査委員会資料で計算された
* 複数の損傷内容を1つの数字にまとめると、結果を見やすくする
* 気温 &rArr; 損傷の程度、という因果関係を見るという目的&rarr;損傷無しの事例(右下部分)も載せる
* 今回の打ち上げの参考にする&rarr;今回の気温も含める

----

事故調査委員会報告書(1986年)でも要領の悪い図示が続いた

![](DataVisualisation/ShuttleRockets1.png)

----

証拠提示のための図として悪い点[@Tufte2006, pp.47-48]

:::{.des-list-boxed}
凡例なし
: 	マークの意味が分からない

データ・インク比率が小さい
: 	data-ink ratio=インク量のうちデータに使われる比率、が多いほど単純明快な図になりやすい。できる限り多くすべき。装飾などのチャート・ジャンク(chart junk、データ以外のゴミ情報)を無くすべき。

明快な関係提示なし
:	因果関係($p\Rightarrow q$)ならば$p, q$が際立って表示されるべき。図で因果関係・相関関係が明快でない=分析者の理解も明快でない(=自分が分かっていないことを説明している)。因果関係に沿わない順序(気温と破損の因果関係で日付に順序としての意味はない)をやめて気温順に配列すべき。
:::

. . .

正式に気温と破損の因果関係を示すならば、気温を変化させながら、ゴムが硬直化する(ために高温ガスを遮断できない)か観察する実験が必要

----

氷水とゴムを使った実験

![](DataVisualisation/IcedRubberExperiment.jpg){width="70%"}

----

事故調委員リチャード・ファインマンの結びの言葉

> 技術を結実させるためには、広報よりも現実を優先させなければならない、自然は騙すことができないから。For a successful technology, reality must take precedence over public relations, for Nature cannot be fooled.

* 効果的にデータを視覚化できていれば、説得力を以て危険性を示すことができた
* 解決策: 気温が高い時期まで打ち上げ延期
* 打ち上げを決めた人たち: 自分が乗組員でも同じ判断をするか

. . .

NASAの目標重視、安全性軽視は変わったのか

----

スペースシャトル・コロンビア(2003年)

::::::::::{.columns}
::::{.column width="60%"}
* 打ち上げ時に断熱材破損、破片&rarr;機体に衝突
* 映像によりNASAはこのことに気付き、12日後の大気圏再突入までに危険を検討した
* 燃料タンクのspray-on form insulation吹き付け式断熱材
* 衝突箇所: タイル vs. ROCという柔らかい部分
* 衝突角度: 緩 vs. 急
* ボーイング社の専門家が3つの報告書を提出、説明
* 「結論: タイル複数枚喪失が基準値以上の熱を引き起こさなければ、損傷しても安全に帰還(複数枚の熱分析は計算中)」
::::

::::{.column width="40%"}
:::{.fragment}
スペースシャトル・コロンビア大気圏再突入爆発事故(2003年)

![](DataVisualisation/ScottLieberman_ShuttleColumbiaAccident.jpg){width="90%"}
:::
::::
::::::::::


----

コロンビア事故: 事故前にすべきだったこと

::::::::::{.columns}
::::{.column width="60%"}
* ボーイング社の報告書: 仮説が明示されず、タイルやRCCの実験データを引用するのみ、体積の違いも考慮していない
* ボーイング社が用意すべきだった図: 素材別パネル、実際の体積をもとにした角度 vs. 損傷(+損傷上限)
::::

::::{.column width="40%"}
:::{.fragment}
![](DataVisualisation/ColumbiaCorrectFigure.png)
:::
::::
::::::::::

----

チャレンジャー事故: 事故前にすべきだったこと

::::::::::{.columns}
::::{.column width="60%"}
仮説は何かを考える

:::{.fragment}
低気温 &rArr; ゴムの密閉性を喪失
:::

:::{.fragment}
 &rArr; 高温ガスがブースター接続部分から漏洩して引火、タンク破損、シャトル分解
:::
::::

::::{.column width="40%"}
:::{.fragment}
仮説の前半[低気温 &rArr; ゴムの密閉性を喪失]を示すだけで十分
:::
::::

::::{.column width="60%"}
* 仮説の検証を目的にデータを視覚化する
* 見ている人に暗算や思考実験を強いない直截な比較
* 実験で示すことが理想だが、「時間がない」ならば過去のデータを示す
   * Tufteの散布図
* もちろん、因果関係ではないが、相関関係でも危険が示されれば延期するのに十分な判断材料
::::

::::{.column width="40%"}
:::{.fragment}
![](DataVisualisation/TufteCorrectedDisplayOfShuttle.png)
:::
::::

::::::::::


----

::: {style="text-align: center;"}
# 1変数の把握
:::

----

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/Wilke/Barplots.jpg){width="100%"}

* 棒グラフ: <RoyalBlue>絶対量</RoyalBlue>を長さで示す
* だから、<Red>0から表示する。</Red>$\approx$で軸を削ってはいけない。長さを削っては駄目だから。
* 差が少ない比較なので、(横)棒だと塗りつぶしの棒中心に視線が行く。ドット図の方が右端に視線が行きやすい。
::::

::::{.column width="40%"}
* 縦棒はグループのラベルが長いと隙間を要するのでスペースを使うし、離れているために比較が難しい。左図:右図を1.5:1にしないと左図のラベルが重なり読めなくなる。
* 横棒にすると解決する。
* でも、時間変化は縦棒の方が把握しやすい。
* ラベルを小さくする、縦書きにする、略記する方が良いかも。
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="40%"}
![](DataVisualisation/Wilke/Piechart.jpg){width="100%"}

<Red>円グラフを使ってはいけない</Red>

![](DataVisualisation/experts.png){width="10%"}[専門家の意見](DataVisualisation/piechartisunchi.mp4)
::::

::::{.column width="60%"}
* 円グラフpie chart: 絶対量を角度で表す
* 人間の目は角度を比べるのは不得意、比較には不適
* 3次元円グラフ: さらに不適、斜め上から見ると角度も分からない
* 絶対量比較だったら棒グラフ、差比較だったら点グラフ、変化比較だったら折れ線グラフを使えばいい
::::
::::::::::

----


::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/Wilke/WrongAndCorrectBarplots.jpg)

* グラフの下部分をカットして上部分を引き延ばす
* 差が強調される
::::

::::{.column width="40%"}
* <Red>差を不当に強調</Red>してデータから得られるメッセージを変えようとしている
* 下部分をカットしたいなら折れ線グラフや点グラフを使えばいい
* 差を不当に強調したい理由、データから何を見せたいかを考えるべき
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/Wilke/Dotplot.jpg)

* ドット図: グループ間の差を比較
* グラフの下部分をカットして上部分を引き延ばす
::::

::::{.column width="40%"}
* 差を不当に強調していない。点グラフは各点の位置と相対距離を伝える。
* 各点を直線で結ばない。グループAはグループBに変化しないので、各点をつながない方が良い
* グループ数に比して差が小さい方が傾向を把握しやすい。数(横軸)の方向に間隔が空きすぎないように図の縮尺を調整する。
* 転置しても良いが、横軸 &rArr; 縦軸という因果関係の誤解を防ぐ必要&larr;横軸はカテゴリ

:::{.fragment}
![](DataVisualisation/Wilke/DotplotTransposed.jpg){width="50%"}
:::
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="40%"}
![](DataVisualisation/Wilke/HeatmapFemaleLifeExpectancy.jpg){width="70%"}

::::

::::{.column width="60%"}
* ヒートマップ: グループ間の差を色彩で比較
* 上下限への距離を色で表現
* 色彩変化で全体的傾向を読む
* 軸の順番は色の濃淡が連続的に出るように選ぶと意図が伝わりやすい
* 傾向を把握してから並べ方を決める
* 国数が多過ぎ
* グループ(cross sectional units)数が多いと、まとめる、標本抽出するなどしない限り、視覚化に向かないこともある。統計学を使ってデータ削減すべき
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="70%"}
![](DataVisualisation/Wilke/HeatmapNormalAndExcessFemaleLifeExpectancySelected.jpg)

::::

::::{.column width="30%"}
* Excess female life expectancy: 女性余命-男性余命
* 2019年のFLE値の大きい順から5カ国目ごとにサンプル。
* FLEとEFLEの時系列を組み合わせることで見えることもある。
* FLEは似ているが、クウェイトはEFLEが低い。クウェイトは所得が高いのにFLEが低い。
::::
::::::::::

----

色覚異常があっても判読できる色彩

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/Wilke/ColourDeficiencyLinePoint.jpg)

* 左は`viridis`ライブラリ、右は色覚異常に対応するOkabe-Itoパレットから指定
::::

::::{.column width="40%"}
* Approximately 8\% of males and 0.5\% of females suffer from some sort of color-vision deficiency, and deuteranomaly is the most common form whereas tritanomaly is relatively rare [@Wilke2019, Section 19.3]
* Deuteranomaly: Red–green color-vision deficiency
* Tritanomaly: Blue–yellow color-vision deficiency. .01\%
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="50%"}
![](DataVisualisation/Wilke/GroupedBarplots.jpg){width="80%"}

::::

::::{.column width="50%"}
* 各時点で絶対量グループ間比較
* 全体的傾向のグループ間比較
* 色を変える必要は無い(比較のために色彩の違いを残した)
* こちらの方が見る人に思考を要求しない
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="50%"}
![](DataVisualisation/Wilke/CasesByGender.jpg){width="70%"}
::::

::::{.column width="50%"}
* Stacked bar plot: 全体の高さとグループ内訳を示す
* 行ごとの縮尺共通: グループごとの高さを示す
* 色を変える必要は無い
* ここまでデータが長く変動が激しいと内訳を比較するのは難しい
* 最下層に来るデータによって印象が変わる
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="70%"}
![](DataVisualisation/Wilke/CasesByAgeGroup.jpg){width="70%"}

::::

::::{.column width="30%"}
* Stacked bar plot: 全体の高さとグループ内訳を示す
* 行ごとの縮尺共通: グループごとの高さを示す
* 色を変える必要は無い
* ここまでデータが長く変動が激しいと内訳を比較するのは難しい
* 最下層に来るデータによって印象が変わる
* 底が揃っているとピークを見つけやすい
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="80%"}
![](DataVisualisation/Wilke/WilkeScatter.jpg)

::::

::::{.column width="20%"}
* 散布図scatter plot: 全体的な分布を示す、45度線で増減を示す
* Slopegraph: 変化の程度(傾斜)を示す、2時点以上も可
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="65%"}
![](DataVisualisation/Wilke/WilkeChoropleth.jpg)

* Choropleth: 地図上に分布を示す
::::

::::{.column width="35%"}
* 境界線で変化することを強調
* 色彩を単調に変化させるべき
* 境界区分が粗すぎると傾向を誤って示す可能性がある
* 見る人が地図を熟知していると前提
::::
::::::::::

----

::: {style="text-align: center;"}
# 複数変数の関係把握
:::

----

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/InfantMortality19902020Arrow.jpg){width="90%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Constructed using World Development Indicators]()</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="40%"}
* 2つの散布図を1つに
* 変化の散布図
* 3変数(+年)の関係を表示
* 意図: 横軸 &rArr; 縦軸 & 経年変化
* 年: 1990と2020には経年数という意味があるので同じ図に描く意味がある
* 意図せざる視覚効果: 低所得国は縦方向、高所得国は横方向の変化が多い
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/InfantMortality19902020.jpg){width="90%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Constructed using World Development Indicators]()</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="40%"}
* 回帰線が下にシフトしただけに見える
* 1990年に比べて2020年の保健指標は低所得国がより改善した
::::
::::::::::

----

::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/InfantMortality19902020ArrowS.jpg){width="90%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Constructed using World Development Indicators]()</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="40%"}
* 回帰線が下にシフトしただけではない
* 低所得国が下に移動し、高所得国が右に移動した結果の回帰線の下方シフト
* 低所得国での保健サービスが整備されたが、所得はあまり増えなかった
* 高所得国では保健サービスはすでに整備されていて改善度合いは少ないが、所得が増えた
::::
::::::::::

----


::::::::::{.columns}
::::{.column width="60%"}
![](DataVisualisation/SchoolEnrollmentInASinglePlot.jpg){width="90%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Constructed using World Development Indicators]()</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="40%"}
長所

* 共通の軸
* 3種類の変数(初等、中等、高等)を比較可能

短所

* ごちゃごちゃして見にくい
* もはや見ているのは回帰線だけ
   * ならば、回帰線だけでいい
   * そうするのは本末転倒
::::
::::::::::

----

```{r layout example}
#### ---
#### Data set creation.

set.seed(93384)
time <- c(0, 0.5, 1, 2, 4, 8, 12, 16, 24)
n <- 32 # no of subjects
data <- expand.grid(ID = 1:n, time = time)
bw <- data.frame(
  ID = sort(unique(data$ID)),
  bw = rlnorm(n, log(75), sdlog = 0.25)
)
bw$bw.category <- cut(bw$bw,
  breaks = quantile(bw$bw, c(0, 0.33, 0.66, 1)),
  labels = paste(c("low", "medium", "high"), "body weight"),
  include.lowest = TRUE
)
data <- merge(data, bw)
data <- data[order(data$ID, data$time), ]
#### Simulate drug concentrations as a function of body weight.
data$conc <- 100 / (data$bw^1.0) * exp(-0.085 * data$time) *
  rlnorm(nrow(data), sdlog = 0.25) + # res. error
  (data$ID - mean(data$ID)) / mean(data$ID) / 4 # r. eff

#### ---

#### Visualisation.
library(ggplot2)
gg <- list()
data$ID <- factor(data$ID)
g <- ggplot(data, aes(x = time, y = conc, group = ID, color = ID)) +
  geom_line()
g <- g + scale_x_continuous(breaks = seq(0, 24, by = 4)) +
  theme_bw() + 
  xlab("time [h]") + 
  ylab("drug concentration [ng/mL]")+ 
  facet_grid(bw.category ~ .) +
  theme(plot.margin = unit(c(2.5, .5, 0.5, 0.5), "lines"),
    legend.position = "none")
gg[["3x1"]] <- g 
gg[["1x3"]] <- g + facet_grid(. ~ bw.category)
#### Add space to the rhs of the first figure for better separation in the cowplot.
gg[["3x1"]] <- gg[["3x1"]] + 
  theme(plot.margin = unit(c(2.5, 4, 0.5, 0.5), "lines"))
```

パネル化の目的: 複数**グループ**間比較

```{r layout example plot, echo = F}
#### Both figures into a single output figure.
library(cowplot)
g <- plot_grid(gg[[1]], gg[[2]], rel_widths = c(1.5, 2),
   labels = c('縦方向', '横方向'))
ggsave(
   paste0("DataVisualisation/LayoutExample1.jpg")
  , g, width = 14*2, height = 8*2, units = "cm",
  dpi = 300
)
```

::::::::::{.columns}
::::{.column width="75%"}
![](DataVisualisation/LayoutExample1.jpg){width="100%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Royal Statistcal Society](https://royal-statistical-society.github.io/datavisguide/)</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="25%"}
:::{style="text-align: center;"}
パネル化の方向:

縦 vs. 横 

&hArr; 

共通にする軸: 

横軸 vs. 縦軸

&hArr; 

比較したい軸:

横軸 vs. 縦軸

* 体重グループ: 離散的な区分なので同じ図に描くのではなく、パネル化が望ましい
:::
::::
::::::::::

----

```{r layout example plot 2, echo = F}
gg <- list()
g <- ggplot(data, aes(x = conc, y = rev(time), group = ID, color = ID)) +
  geom_line()
g <- g + scale_y_continuous(breaks = seq(0, 24, by = 4)) +
  theme_bw() + 
  ylab("time [h]") + 
  xlab("drug concentration [ng/mL]")+ 
  facet_grid(bw.category ~ .) +
  theme(legend.position = "none", 
    plot.margin = unit(c(2.5, .5, 0.5, 0.5), "lines"))
gg[["3x1"]] <- g 
gg[["1x3"]] <- g + facet_grid(. ~ bw.category)
#### Add space to the rhs of the first figure for better separation in the cowplot.
gg[["3x1"]] <- gg[["3x1"]] + 
  theme(plot.margin = unit(c(2.5, 4, 0.5, 0.5), "lines"))
#### Both figures into a single output figure.
library(cowplot)
g <- plot_grid(gg[[1]], gg[[2]], rel_widths = c(2, 1.5), 
   labels = c('縦方向', '横方向'))
ggsave(
   paste0("DataVisualisation/LayoutExample2.jpg")
  , g, width = 14*2, height = 8*2, units = "cm",
  dpi = 300
)
```

::::::::::{.columns}
縦: 濃度、横: 時間 &rarr; 縦: 時間、横: 濃度に変更

::::{.column width="75%"}
![](DataVisualisation/LayoutExample2.jpg){width="100%"}

<script src="https://cdn.lordicon.com/lordicon.js"></script>
<lord-icon
    src="https://cdn.lordicon.com/ujxzdfjx.json"
    trigger="hover"
    style="width:30px;height:30px">
</lord-icon> <span style="text-align: left; font-size: 20px">[Royal Statistcal Society](https://royal-statistical-society.github.io/datavisguide/)</span><div style="text-align: right; font-size: 12px"><a href="https://lordicon.com/">Animated icons by Lordicon.com</a></div>
::::

::::{.column width="25%"}
横軸: 濃度

縦軸: 時間

縦方向パネル: 横軸変数の比較


横方向パネル: 縦軸変数の比較
::::
::::::::::

----

::: {style="text-align: center;"}
# やってはいけない視覚化
:::

----

チェック項目と推奨する原則[@Tufte2001]

:::{.des-list-boxed}
嘘比率lie factor
:	図での大きさ/数値の大きさ。数値を図で誇張・矮小化している比率。1でなければならない。

データ・インク比率data-ink ratio
:	全ての線や模様のなかでデータの占める比率。合理的範囲で高めるべし。

非データ・インク比率nondata-ink ratio
:	全ての線や模様のなかでデータ以外の占める比率。1-データ・インク比率。チャート・ジャンク。合理的範囲で減らすべし。

冗長なデータ・インクredundant data-ink ratio
: 全ての線や模様で同じ情報が重複している比率。減らすべし。

デザイン変更design variation
:	一部だけデザインを変えて誇張・矮小化すること。やってはいけない。

図の次元graphical dimensions
:	面積(2)、体積(3)。データの次元に合わせるべし。

データ密度data density
:	面積当たりデータ表示の比率。図を縮小することで多くの図を詰め込むべし。
:::

----

[DataVisualisation.pdf](DataVisualisation.pdf#page=221)

----

::::::::::{.columns}
::::{.column width="80%"}
::::
::::{.column width="20%"}
::::
::::::::::

----

#### References

::: {#refs}
:::
